<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kryptos</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"></script>
    <script src="static/app.js"></script>
</head>
<body>
    <nav class="navbar navbar-light bg-light" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
        <a class="navbar-brand mb-0 h2" href="home"><b>Kry<span style="color: rgb(8, 109, 73);">ptos***</b></span></a>
    </nav>

    <style>
        .card-container {
            display: flex;
            justify-content: center;
            gap: 60px;
            margin-left: -150px;
        }
        .card {
            margin: 10px;
            font-size: 24px;
            width: 100%;
            max-width: 18rem;
        }
        .custom-nav-column {
            background-color: rgb(8, 109, 73);
            color: white;
        }
        .custom-tab-content {
            background-color: rgb(8, 109, 73);
        }
        .nav-pills .nav-link.active {
            background-color: rgb(8, 109, 73);
            color: white;
        }
        .nav-pills .nav-link:hover {
            background-color: rgb(8, 109, 73);
            color: white;
        }
        .nav-pills .nav-link {
            color: black;
        }
        .btn-success {
            width: 50px;
            height: 50px;
            margin-top: 30px;
            border-radius: 10px;
            background-color: rgb(8, 109, 73);
            color: #ffff;
            margin-left: -20px;
        }
        .fixed-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .new-container {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .custom-btn {
            width: 70px;
            height: 70px;
            margin-top: 30px;
            border-radius: 10px;
            background-color: #ffff;
            color: rgb(8, 109, 73);
            margin-left: -20px;
        }
        .modal-dialog1 {
            max-width: 35%; /* Adjust this value as needed */
            margin: 1.75rem auto; /* Adjusting the margin to center the modal */
            padding-right: 10px;
        }
        #v-pills-logout-tab:hover {
            background-color: #A32424 !important; /* Change background color to red on hover */
            color: white; /* Change text color to white */
        }

    </style>

    <div class="row">
        <div class="col-3">
            <div class="nav flex-column nav-pills p-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                <a class="nav-link" id="v-pills-home-tab" href="home" role="tab" aria-controls="v-pills-home" aria-selected="false">Home</a>
                <a class="nav-link" id="v-pills-profile-tab" data-toggle="modal" href="#masterPasswordModal" role="tab" aria-controls="v-pills-profile" aria-selected="false">Key Vault</a>
                <a class="nav-link active" id="v-pills-messages-tab" href="passwordvault" role="tab" aria-controls="v-pills-messages" aria-selected="false">Records</a>
                <a class="nav-link" id="v-pills-settings-tab" data-toggle="pill" href="#v-pills-settings" role="tab" aria-controls="v-pills-settings" aria-selected="false">Settings</a>
                <a class="nav-link" id="v-pills-logout-tab" href="/logout" role="tab" aria-controls="v-pills-logout" aria-selected="false">Logout</a> <!-- Logout pill -->
            </div>
        </div>
        <div class="col-9">
            <div class="tab-content" id="v-pills-tabContent">
                <div class="tab-pane fade show active" id="v-pills-home" role="tabpanel" aria-labelledby="v-pills-home-tab">
                    <!-- The Modal -->
                    <div class="modal fade" id="inputModal">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <!-- Modal Header -->
                                <div class="modal-header">
                                    <h4 class="modal-title">Enter Key Details</h4>
                                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                                </div>
                                <!-- Modal body -->
                                <div class="modal-body">
                                    <form id="keyForm">
                                        <div class="form-group">
                                            <label1 for="keyName">Key Name:</label1>
                                            <input type="text" class="form-control" id="keyName" name="keyName" required>
                                        </div>
                                        <button type="submit" id="submitBtn" class="btn btn-primary">Submit</button>
                                    </form>
                                </div>
                                <!-- Modal footer -->
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Master Password Modal -->
                <div class="modal fade" id="masterPasswordModal" tabindex="-1" role="dialog" aria-labelledby="masterPasswordModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="masterPasswordModalLabel">Enter Master Password</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="masterPasswordForm">
                                    <div class="form-group">
                                        <label1 for="masterPassword">Master Password:</label1>
                                        <input type="password" class="form-control" id="masterPassword" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Verify</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="keysModal" tabindex="-1" role="dialog" aria-labelledby="keysModalLabel" aria-hidden="true">
                    <div class="modal-dialog1" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="keysModalLabel">Key Vault</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body modal-dialog">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Key Name</th>
                                            <th>Key</th>
                                        </tr>
                                    </thead>
                                    <tbody id="keysTableBody">
                                        <!-- Keys will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container-fluid mt-5">
                    <div id="containerWrapper"></div>
                </div>
                <!-- Fixed Button -->
                <button type="button" class="btn btn-success fixed-button" data-toggle="modal" data-target="#addPasswordModal">+</button>

                <!-- Add Password Modal -->
                <div class="modal fade" id="addPasswordModal" tabindex="-1" role="dialog">
                    <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <form action="{{ url_for('add_password') }}" method="POST">
                        <div class="modal-header">
                            <h5 class="modal-title">Add New Password</h5>
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <!-- Select Existing Key or Enter New Key -->
                            <div class="form-group">
                            <label for="key_id">Select Category</label>
                            <select id="key_id" name="key_id" class="form-control">
                                {% for category in categories %}
                                <option value="{{ category.Key_id }}">{{ category.key_name }}</option>
                                {% endfor %}
                                <option value="new">Add New Category</option>
                            </select>
                            </div>
                            <div class="form-group" id="new_key_field" style="display: none;">
                            <label for="new_key_name">New Category Name</label>
                            <input type="text" id="new_key_name" name="new_key_name" class="form-control">
                            </div>
                
                            <!-- Password Details -->
                            <div class="form-group">
                            <label for="site">Site</label>
                            <input type="text" name="site" class="form-control">
                            </div>
                            <div class="form-group">
                            <label for="login_name">Login Name</label>
                            <input type="text" name="login_name" class="form-control">
                            </div>
                            <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" name="passwords" class="form-control">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Add Password</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                        </form>
                    </div>
                    </div>
                </div>
               <!-- Modal for Updating Password --> <!--NEW ADDITION-->
                <!-- Modal for Updating Password -->
                <div class="modal fade" id="updatePasswordModal" tabindex="-1" role="dialog" aria-labelledby="updatePasswordModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header"> 
                        <h5 class="modal-title" id="updatePasswordModalLabel">Enter Details</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"> <!-- Bootstrap 4 syntax -->
                            <span aria-hidden="true">&times;</span>
                        </button>
                        </div> 
                        <div class="modal-body">
                        <!-- Use method POST and action pointing to your update route -->
                        <form id="updatePasswordForm" method="POST" action="" class="form-horizontal">
                            <!-- Include a hidden input for key_id if necessary -->
                            <input type="hidden" id="keyId" name="key_id" value="">
                
                            <div class="form-group row">
                            <label for="title" class="col-sm-4 col-form-label">Title</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" placeholder="Website/Application Name" id="title" name="title" required>
                            </div>
                            </div>
                
                            <div class="form-group row">
                            <label for="loginName" class="col-sm-4 col-form-label">Login Name</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" id="loginName" name="login_name" placeholder="Email/Username" required>
                            </div>
                            </div>
                
                            <div class="form-group row">
                            <label for="passwords" class="col-sm-4 col-form-label">Password</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" id="passwords" name="passwords" placeholder="Type Password" required>
                            </div>
                            </div>
                
                            <div class="form-group row">
                            <label for="site" class="col-sm-4 col-form-label">Site (URL)</label>
                            <div class="col-sm-8">
                                <input type="url" class="form-control" id="site" name="site" placeholder="https://example.com" required>
                            </div>
                            </div>
                
                            <div class="form-group row">
                            <label for="keysName" class="col-sm-4 col-form-label">Key Name</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" id="keysName" name="keys_name" placeholder="Insert Key Name" required>
                            </div>
                            </div>
                
                            <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                
                        </form>
                        </div>
                    </div>
                    </div>
                </div>
  
  
                <!-- Modal for Key Name Verification -->
                <div class="modal fade" id="keyNameModal" tabindex="-1" role="dialog" aria-labelledby="keyNameModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="keyNameModalLabel">Enter Key Name</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="keyNameForm">
                                    <div class="form-group">
                                        <label1 for="modalKeyName">Key Name:</label1>
                                        <input type="text" class="form-control" id="modalKeyName" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Verify</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                                <!-- Navbar for Scrollspy Navigation -->
                    <nav id="navbar-example2" class="navbar bg-body-tertiary px-3 mb-3">
                        <a class="navbar-brand" href="#">Records Vault</a>
                        <ul class="nav nav-pills">
                        {% for category in categories %}
                            <li class="nav-item">
                            <a class="nav-link" href="#scrollspyHeading{{ category.Key_id }}">{{ category.key_name }}</a>
                            </li>
                        {% endfor %}
                        </ul>
                    </nav>
                    
                    <!-- Scrollable Content Area -->
                    <div 
                    data-bs-spy="scroll" 
                    data-bs-target="#navbar-example2" 
                    data-bs-root-margin="0px 0px -40%" 
                    data-bs-smooth-scroll="true" 
                    class="scrollspy-example bg-body-tertiary p-3 rounded-2" 
                    tabindex="0"
                    >
                    {% for category in categories %}
                    <h4 id="scrollspyHeading{{ category.key_id }}">{{ category.key_name }}</h4>
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>Site</th>
                                <th>Login Name</th>
                                <th colspan="3">Password</th> <!-- Merged header for Password, Update, Delete -->
                            </tr>
                        </thead>
                        <tbody>
                            {% for password in passwords_by_category[category.key_id] %}
                                <tr>
                                    <td>{{ password.site }}</td>
                                    <td>{{ password.login_name }}</td>
                                    <td>{{ password.passwords }}</td> <!-- Decrypted password -->
                                    <td>
                                        <button class="btn-sm" onclick="updatePassword({{ password.id }})">Update</button>
                                    </td>
                                    <td>
                                        <button class="btn-sm" onclick="deletePassword({{ password.id }})">Delete</button>

                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endfor %}
                

    
            <div class="tab-pane fade" id="v-pills-profile" role="tabpanel" aria-labelledby="v-pills-profile-tab">...</div>
            <div class="tab-pane fade" id="v-pills-messages" role="tabpanel" aria-labelledby="v-pills-messages-tab">...</div>
            <div class="tab-pane fade" id="v-pills-settings" role="tabpanel" aria-labelledby="v-pills-settings-tab">...</div>
        </div>
    </div>
</div>
<script>
        function deletePassword(passwordId) {
            if (!confirm("Are you sure you want to delete this password?")) {
                return;
            }
    
            fetch(`/delete_password/${passwordId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Password deleted successfully");
                    location.reload(); // Refresh page to reflect deletion
                } else {
                    alert("Failed to delete the password: " + data.message);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An error occurred while trying to delete the password.");
            });
        }
        function updatePassword(passwordId) {
            fetch(`/get_password/${passwordId}`)
              .then(response => response.json())
              .then(data => {
                if (data.success === false) {
                  alert(data.message);
                  return;
                }
          
                // Check and set form fields
                const fields = [
                  { id: 'title', value: data.title },
                  { id: 'loginName', value: data.login_name },
                  { id: 'passwords', value: data.password },
                  { id: 'site', value: data.site },
                  { id: 'keysName', value: data.keys_name },
                  { id: 'keyId', value: data.key_id },
                ];
          
                fields.forEach(field => {
                  const element = document.getElementById(field.id);
                  if (element) {
                    element.value = field.value;
                  } else {
                    console.error(`Element with ID '${field.id}' not found.`);
                  }
                });
          
                // Set the form action
                const formElement = document.getElementById('updatePasswordForm');
                if (formElement) {
                  formElement.action = `/update_password/${passwordId}`;
                } else {
                  console.error("Form element with ID 'updatePasswordForm' not found.");
                }
          
                // Show the modal
                $('#updatePasswordModal').modal('show');
              })
              .catch(error => {
                console.error("Error fetching password details:", error);
                alert("An error occurred while fetching the password details.");
              });
          }

          console.log('Data received:', data);

const titleElement = document.getElementById('title');
console.log('titleElement:', titleElement);

if (titleElement) {
  titleElement.value = data.title;
} else {
  console.error("Element with ID 'title' not found.");
}
</script>


</body>
</html>
